<!DOCTYPE html>
<html>
  <head>
    <title>Show Issuing Card Details - Corrected</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      body { font-family: sans-serif; }
      #output {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #ddd;
        min-height: 50px;
        background-color: #f9f9f9;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <h2>Card Details Viewer</h2>
    <p>Loading details for Card ID from URL...</p>
    
    <button id="showCardDetails">Show Card Details</button>

    <div id="output">Click 'Show Card Details' to proceed.</div>

    <script>
      // Helper to extract query parameters from URL
      function getUrlParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      document.getElementById("showCardDetails").addEventListener("click", async () => {
        const cardId = getUrlParam("cardId");
        const accountId = getUrlParam("accountId");
        const output = document.getElementById("output");

        output.textContent = "Loading card details...";

        if (!cardId || !accountId) {
          output.innerHTML = `<pre>Error: Missing required parameters in URL.</pre>
          <p>Example URL format: 
          <code>.../show-card.html?cardId=ic_XXXXXX&accountId=acct_XXXXXX</code></p>`;
          return;
        }

        try {
          // Initialize Stripe with connected account
          const stripe = Stripe(
            "pk_test_51RnIO1PnjxZLQWbCzh7H4jjbQC8e6InO0PWjJXMsUYUVBOQUd50KqxrQfhPGEwVSwDoIS5xUBP8JvDGJ1wIr8iGr009Im9BXGV",
            { stripeAccount: accountId }
          );

          // 1. Generate nonce for the issuing card
          const { nonce, error: nonceError } = await stripe.createEphemeralKeyNonce({
            issuingCard: cardId
          });

          if (nonceError) throw nonceError;
          if (!nonce) throw new Error("Nonce generation failed.");

          // 2. Call backend to reveal card and get client_secret
          const response = await fetch(
            "https://us-central1-teenbeez.cloudfunctions.net/createIssuingEphemeralKey",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ cardId, nonce, accountId }),
            }
          );

          const data = await response.json();

          if (!data.success) {
            throw new Error(data.error || "Backend failed to create client secret");
          }

          if (!data.clientSecret || !data.clientSecret.includes("_secret_")) {
            throw new Error("Invalid client secret returned from backend.");
          }

          // 3. Create and mount the Issuing Card Details element
          const elements = stripe.elements({
            clientSecret: data.clientSecret,
          });

          const cardDetails = elements.create("issuingCardDetails");
          output.innerHTML = "";
          cardDetails.mount("#output");

        } catch (err) {
          console.error("Error showing card details:", err);
          output.innerHTML = `<pre>Error showing card details: ${err.message}</pre>`;
        }
      });
    </script>
  </body>
</html>
