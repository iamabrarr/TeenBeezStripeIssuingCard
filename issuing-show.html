<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Show Stripe Issuing Card Details</title>
    <script src="https://js.stripe.com/v3/"></script>
  </head>
  <body>
    <h2>Stripe Issuing Card Details</h2>

    <div id="card-number"></div>
    <div id="card-expiry"></div>
    <div id="card-cvc"></div>

    <button id="showCardBtn">Show Card Details</button>

    <script>
      async function showCardDetails() {
        const params = new URLSearchParams(window.location.search);
        const cardId = params.get("cardId");
        const accountId = params.get("accountId");

        if (!cardId || !accountId) {
          alert("Missing cardId or accountId");
          return;
        }

        const functionUrl =
          "https://us-central1-teenbeez.cloudfunctions.net/createIssuingEphemeralKey";

        try {
          // 1. Create ephemeral key (with dummy nonce)
          const response = await fetch(functionUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              cardId,
              nonce: "fake_nonce_" + Math.random().toString(36).substring(2),
              accountId,
            }),
          });

          const data = await response.json();
          if (!data.success) throw new Error(data.error || "Ephemeral key failed");

          const ephemeralKeySecret = data.ephemeralKeySecret;

          // 2. Initialize Stripe with your publishable key
          const stripe = Stripe("pk_live_or_test_your_publishable_key_here", {
            stripeAccount: accountId,
          });

          // 3. Mount the Issuing Card Number Element
          const elements = stripe.elements({ clientSecret: ephemeralKeySecret });
          const cardNumber = elements.create("issuingCardNumberDisplay", {
            issuingCard: cardId,
          });
          cardNumber.mount("#card-number");

          const cardExpiry = elements.create("issuingCardExpiryDisplay", {
            issuingCard: cardId,
          });
          cardExpiry.mount("#card-expiry");

          const cardCvc = elements.create("issuingCardCvcDisplay", {
            issuingCard: cardId,
          });
          cardCvc.mount("#card-cvc");
        } catch (err) {
          console.error("Error:", err);
          alert("Error showing card details: " + err.message);
        }
      }

      document
        .getElementById("showCardBtn")
        .addEventListener("click", showCardDetails);
    </script>
  </body>
</html>
