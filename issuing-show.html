<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Show Stripe Issuing Card Details</title>
    <script src="https://js.stripe.com/v3/"></script>
  </head>
  <body>
    <h2>Stripe Issuing Card Details</h2>

    <div id="card-details"></div>
    <button id="showCardBtn">Show Card Details</button>

    <script>
      async function showCardDetails() {
        const params = new URLSearchParams(window.location.search);
        const cardId = params.get("cardId");
        const accountId = params.get("accountId");
        const nonce = params.get("nonce"); // nonce should come from your mobile app backend

        if (!cardId || !accountId || !nonce) {
          alert("Missing cardId, accountId, or nonce in URL");
          return;
        }

        const functionUrl =
          "https://us-central1-YOUR_PROJECT.cloudfunctions.net/createIssuingEphemeralKey";

        try {
          // Step 1: Request ephemeral key
          const response = await fetch(functionUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cardId, nonce, accountId }),
          });

          const data = await response.json();
          if (!data.success) {
            throw new Error(data.error || "Failed to create ephemeral key");
          }

          const ephemeralKeySecret = data.ephemeralKeySecret;

          // Step 2: Initialize Stripe with the ephemeral key
          const stripe = Stripe(ephemeralKeySecret);

          // Step 3: Retrieve the card details
          const { card } = await stripe.issuing.cards.retrieve(cardId);

          document.getElementById("card-details").innerHTML = `
            <p><strong>Card Number:</strong> ${card.number}</p>
            <p><strong>Expiry:</strong> ${card.exp_month}/${card.exp_year}</p>
            <p><strong>CVC:</strong> ${card.cvc}</p>
          `;
        } catch (err) {
          console.error("Error:", err);
          alert("Error showing card details: " + err.message);
        }
      }

      document
        .getElementById("showCardBtn")
        .addEventListener("click", showCardDetails);
    </script>
  </body>
</html>
