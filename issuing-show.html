<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Show Stripe Issuing Card Details</title>
    <script src="https://js.stripe.com/v3/"></script>
  </head>
  <body>
    <h2>Stripe Issuing Card Details 1</h2>
    <div id="card-details">Loading...</div>
    <button id="showCardBtn">Show Card Details</button>

    <script>
      const STRIPE_PUBLISHABLE_KEY = "pk_test_51RnIO1PnjxZLQWbCzh7H4jjbQC8e6InO0PWjJXMsUYUVBOQUd50KqxrQfhPGEwVSwDoIS5xUBP8JvDGJ1wIr8iGr009Im9BXGV";
      const FUNCTION_URL =
        "https://us-central1-teenbeez.cloudfunctions.net/createIssuingEphemeralKey";

      async function showCardDetails() {
        const params = new URLSearchParams(window.location.search);
        const cardId = params.get("cardId");
        const accountId = params.get("accountId");

        if (!cardId || !accountId) {
          alert("Missing cardId or accountId in URL");
          return;
        }

        try {
          // Step 1: Get ephemeral key from Firebase Function
          const response = await fetch(FUNCTION_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cardId, accountId }),
          });

          const data = await response.json();
          if (!data.success) throw new Error(data.error);
          const ephemeralKeySecret = data.ephemeralKeySecret;

          // Step 2: Initialize Stripe with the ephemeral key
          const stripe = Stripe(STRIPE_PUBLISHABLE_KEY, {
            apiVersion: "2023-10-16",
          });

          // Step 3: Retrieve the issuing card details securely
          const result = await fetch("https://api.stripe.com/v1/issuing/cards/" + cardId, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${ephemeralKeySecret}`,
            },
          });

          const cardData = await result.json();
          if (cardData.error) throw new Error(cardData.error.message);

          // Step 4: Display the card details
          document.getElementById("card-details").innerHTML = `
            <p><strong>Card Number:</strong> ${cardData.number || "Hidden in live mode"}</p>
            <p><strong>Expiry:</strong> ${cardData.exp_month}/${cardData.exp_year}</p>
            <p><strong>CVC:</strong> ${cardData.cvc || "Hidden in live mode"}</p>
          `;
        } catch (err) {
          console.error("Error:", err);
          alert("Error showing card details: " + err.message);
        }
      }

      document
        .getElementById("showCardBtn")
        .addEventListener("click", showCardDetails);
    </script>
  </body>
</html>
