<!DOCTYPE html>
<html>
  <head>
    <title>Card Details</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      body { font-family: Arial, sans-serif; padding: 30px; background: #f9f9f9; }
      .card-info { display: flex; flex-direction: column; gap: 15px; max-width: 400px; margin: auto; }
      .stripe-element { padding: 12px; border: 1px solid #ccc; border-radius: 8px; background: white; }
    </style>
  </head>
  <body>
    <h2 style="text-align:center;">Secure Card Details 2</h2>
    <div class="card-info">
      <div id="card-number" class="stripe-element"></div>
      <div id="card-expiry" class="stripe-element"></div>
      <div id="card-cvc" class="stripe-element"></div>
    </div>

    <script>
      (async () => {
        // Read cardId and accountId from URL
        const urlParams = new URLSearchParams(window.location.search);
        const cardId = urlParams.get("cardId");
        const accountId = urlParams.get("accountId");
        if (!cardId || !accountId) {
          alert("Missing cardId or accountId in URL");
          return;
        }

        // Initialize Stripe with your publishable key and connected accountId
        const stripe = Stripe("pk_test_51RnIO1PnjxZLQWbCzh7H4jjbQC8e6InO0PWjJXMsUYUVBOQUd50KqxrQfhPGEwVSwDoIS5xUBP8JvDGJ1wIr8iGr009Im9BXGV", {
          stripeAccount: accountId,
          apiVersion: "2023-10-16"
        });

        try {
          // Create ephemeral key nonce for the cardId
          const nonceResult = await stripe.createEphemeralKeyNonce({ issuingCard: cardId });
          const nonce = nonceResult.nonce;

          // Call your Cloud Function with cardId, accountId, and nonce to get ephemeralKeySecret
          const res = await fetch("https://us-central1-teenbeez.cloudfunctions.net/createIssuingEphemeralKey", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cardId, accountId, nonce })
          });
          const data = await res.json();

          if (!data.success) {
            alert("Error: " + data.error);
            return;
          }

          // Create elements with issuingCard, nonce, and ephemeralKeySecret
          const elements = stripe.elements({
            issuingCard: cardId,
            nonce: nonce,
            ephemeralKeySecret: data.ephemeralKeySecret,
          });

          // Create "Display" elements to show card details securely
          const cardNumber = elements.create("issuingCardNumberDisplay");
          const cardExpiry = elements.create("issuingCardExpiryDisplay");
          const cardCvc = elements.create("issuingCardCvcDisplay");

          // Mount the elements in the DOM
          cardNumber.mount("#card-number");
          cardExpiry.mount("#card-expiry");
          cardCvc.mount("#card-cvc");
        } catch (error) {
          alert("Unexpected error: " + error.message);
          console.error(error);
        }
      })();
    </script>
  </body>
</html>
