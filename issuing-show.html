<!DOCTYPE html>
<html>
  <head>
    <title>Card Details</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      body { font-family: Arial, sans-serif; padding: 30px; background: #f9f9f9; }
      .card-info { display: flex; flex-direction: column; gap: 15px; max-width: 400px; margin: auto; }
      .stripe-element { padding: 12px; border: 1px solid #ccc; border-radius: 8px; background: white; }
    </style>
  </head>
  <body>
    <h2 style="text-align:center;">Secure Card Details 46</h2>
    <div class="card-info">
      <div id="card-number" class="stripe-element"></div>
      <div id="card-expiry" class="stripe-element"></div>
      <div id="card-cvc" class="stripe-element"></div>
    </div>

    <script>
      (async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const cardId = urlParams.get("cardId");
        const accountId = urlParams.get("accountId");

        if (!cardId || !accountId) {
          alert("Missing cardId or accountId in URL");
          return;
        }

        console.log("cardId:", cardId, "accountId:", accountId);

        const stripe = Stripe(
          "pk_test_51RnIO1PnjxZLQWbCzh7H4jjbQC8e6InO0PWjJXMsUYUVBOQUd50KqxrQfhPGEwVSwDoIS5xUBP8JvDGJ1wIr8iGr009Im9BXGV",
          { stripeAccount: accountId }
        );

        try {
          // Create ephemeral key nonce tied to cardId
          const nonceResult = await stripe.createEphemeralKeyNonce({ issuingCard: cardId });
          const nonce = nonceResult.nonce;

          // Fetch ephemeral key from your Cloud Function
          const res = await fetch("https://us-central1-teenbeez.cloudfunctions.net/createIssuingEphemeralKey", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cardId, accountId, nonce }),
          });

          const data = await res.json();
          if (!data.success) {
            alert("Error: " + data.error);
            return;
          }

          const ephemeralKeySecret = data.ephemeralKeySecret;
          const elements = stripe.elements();

          // âœ… Each element must receive issuingCard, nonce, and ephemeralKeySecret
          const cardNumberDisplay = elements.create("issuingCardNumberDisplay", {
            issuingCard: cardId,
            nonce,
            ephemeralKeySecret,
          });
          cardNumberDisplay.mount("#card-number");

          const cardExpiryDisplay = elements.create("issuingCardExpiryDisplay", {
            issuingCard: cardId,
            nonce,
            ephemeralKeySecret,
          });
          cardExpiryDisplay.mount("#card-expiry");

          const cardCvcDisplay = elements.create("issuingCardCvcDisplay", {
            issuingCard: cardId,
            nonce,
            ephemeralKeySecret,
          });
          cardCvcDisplay.mount("#card-cvc");

        } catch (error) {
          alert("Unexpected error: " + error.message);
          console.error(error);
        }
      })();
    </script>
  </body>
</html>
