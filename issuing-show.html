<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Show Stripe Issuing Card Details</title>
    <script src="https://js.stripe.com/v3/"></script>
  </head>
  <body>
    <h2>Stripe Issuing Card Details</h2>

    <div id="card-details"></div>
    <button id="showCardBtn">Show Card Details</button>

    <script>
      async function showCardDetails() {
        const params = new URLSearchParams(window.location.search);
        const cardId = params.get("cardId");
        const accountId = params.get("accountId");

        if (!cardId || !accountId) {
          alert("Missing cardId or accountId in URL");
          return;
        }

        try {
          // Step 1: Initialize Stripe with your publishable key
          const stripe = Stripe("pk_live_YOUR_PUBLISHABLE_KEY"); // replace with your real key

          // Step 2: Create nonce using Stripe.js (client-side)
          const nonceResult = await stripe.issuing.cards.createNonce(cardId);
          if (!nonceResult || !nonceResult.nonce) {
            throw new Error("Failed to create nonce");
          }

          const nonce = nonceResult.nonce;
          console.log("Created nonce:", nonce);

          // Step 3: Request ephemeral key from Firebase Cloud Function
          const response = await fetch(
            "https://us-central1-teenbeez.cloudfunctions.net/createIssuingEphemeralKey",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ cardId, nonce, accountId }),
            }
          );

          const data = await response.json();
          if (!data.success) {
            throw new Error(data.error || "Failed to create ephemeral key");
          }

          const ephemeralKeySecret = data.ephemeralKeySecret;

          // Step 4: Reveal full card details using Stripe.js
          const cardDetails = await stripe.issuing.cards.reveal(cardId, {
            ephemeralKeySecret: ephemeralKeySecret,
          });

          console.log("Card Details:", cardDetails);

          document.getElementById("card-details").innerHTML = `
            <p><strong>Card Number:</strong> ${cardDetails.card.number}</p>
            <p><strong>Expiry:</strong> ${cardDetails.card.exp_month}/${cardDetails.card.exp_year}</p>
            <p><strong>CVC:</strong> ${cardDetails.card.cvc}</p>
          `;
        } catch (err) {
          console.error("Error:", err);
          alert("Error showing card details: " + err.message);
        }
      }

      document
        .getElementById("showCardBtn")
        .addEventListener("click", showCardDetails);
    </script>
  </body>
</html>
