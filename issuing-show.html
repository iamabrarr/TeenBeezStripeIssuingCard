<!DOCTYPE html>
<html>
  <head>
    <title>Card Details</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      body { font-family: Arial, sans-serif; padding: 30px; background: #f9f9f9; }
      .card-info { display: flex; flex-direction: column; gap: 15px; max-width: 400px; margin: auto; }
      .stripe-element { padding: 12px; border: 1px solid #ccc; border-radius: 8px; background: white; }
    </style>
  </head>
  <body>
    <h2 style="text-align:center;">Secure Card Details</h2>
    <div class="card-info">
      <div id="card-number" class="stripe-element"></div>
      <div id="card-expiry" class="stripe-element"></div>
      <div id="card-cvc" class="stripe-element"></div>
    </div>

    <script>
      (async () => {
        // Read cardId and accountId from URL
        const urlParams = new URLSearchParams(window.location.search);
        const cardId = urlParams.get("cardId");
        const accountId = urlParams.get("accountId");

        if (!cardId || !accountId) {
          alert("Missing cardId or accountId in URL");
          return;
        }

        // Call your Cloud Function to create an ephemeral key
        const res = await fetch("https://us-central1-teenbeez.cloudfunctions.net/createIssuingEphemeralKey", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cardId, accountId })
        });
        const data = await res.json();
        if (!data.success) {
          alert("Error: " + data.error);
          return;
        }

        // Initialize Stripe with your publishable key
        const stripe = Stripe("pk_test_51RnIO1PnjxZLQWbCzh7H4jjbQC8e6InO0PWjJXMsUYUVBOQUd50KqxrQfhPGEwVSwDoIS5xUBP8JvDGJ1wIr8iGr009Im9BXGV", {
          stripeAccount: accountId,
        });

        const elements = stripe.elements({
          clientSecret: data.ephemeralKeySecret
        });

        // Create secure Stripe-hosted elements
        const cardNumber = elements.create("issuingCardNumber");
        const cardExpiry = elements.create("issuingCardExpiry");
        const cardCvc = elements.create("issuingCardCvc");

        cardNumber.mount("#card-number");
        cardExpiry.mount("#card-expiry");
        cardCvc.mount("#card-cvc");
      })();
    </script>
  </body>
</html>
