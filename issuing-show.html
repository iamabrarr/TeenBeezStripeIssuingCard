<!DOCTYPE html>
<html>
  <head>
    <title>Show Issuing Card Details 2</title>
    <script src="https://js.stripe.com/v3/"></script>
  </head>
  <body>
    <h2>Show Card Details</h2>

    <input id="cardId" placeholder="Enter card ID" value="ic_XXXXXX" />
    <input id="accountId" placeholder="Enter account ID" value="acct_XXXXXX" />
    <button id="showCardDetails">Show Card Details</button>

    <pre id="output"></pre>

    <script>
      document.getElementById("showCardDetails").addEventListener("click", async () => {
        const cardId = document.getElementById("cardId").value.trim();
        const accountId = document.getElementById("accountId").value.trim();
        const output = document.getElementById("output");
        output.textContent = "Loading...";

        try {
          // 1. Get nonce from backend (temporary card token)
          const nonceResponse = await fetch("https://us-central1-YOUR_PROJECT.cloudfunctions.net/createNonce", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cardId, accountId }),
          });
          const nonceData = await nonceResponse.json();
          if (!nonceData.success) throw new Error(nonceData.error || "Failed to create nonce");

          // 2. Create ephemeral key from backend
          const ephKeyResponse = await fetch("https://us-central1-YOUR_PROJECT.cloudfunctions.net/createIssuingEphemeralKey", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              cardId,
              nonce: nonceData.nonce,
              accountId,
            }),
          });
          const ephKeyData = await ephKeyResponse.json();
          if (!ephKeyData.success) throw new Error(ephKeyData.error || "Failed to create ephemeral key");

          // 3. Initialize Stripe with the ephemeral key and explicit API version
          const stripe = Stripe(ephKeyData.publishableKey, {
            stripeAccount: accountId,
            apiVersion: "2023-10-16", // IMPORTANT: set same version here
          });

          // 4. Show issuing card details
          const result = await stripe.renderIssuingCardDetails({
            ephemeralKeySecret: ephKeyData.ephemeralKeySecret,
            nonce: nonceData.nonce,
            element: "#output",
          });

          if (result.error) throw result.error;
        } catch (err) {
          output.textContent = "Error showing card details: " + err.message;
        }
      });
    </script>
  </body>
</html>
