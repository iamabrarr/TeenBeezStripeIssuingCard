<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Show Stripe Issuing Card Details</title>
    <script src="https://js.stripe.com/v3/"></script>
  </head>
  <body>
    <h2>Stripe Issuing Card Details</h2>
    <div id="card-details"></div>
    <button id="showCardBtn">Show Card Details</button>

    <script>
      const STRIPE_PUBLISHABLE_KEY = "pk_test_51RnIO1PnjxZLQWbCzh7H4jjbQC8e6InO0PWjJXMsUYUVBOQUd50KqxrQfhPGEwVSwDoIS5xUBP8JvDGJ1wIr8iGr009Im9BXGV";
      const EPHEMERAL_FN_URL = "https://us-central1-teenbeez.cloudfunctions.net/createIssuingEphemeralKey";

      async function showCardDetails() {
        const params = new URLSearchParams(window.location.search);
        const cardId = params.get("cardId");
        const accountId = params.get("accountId");

        if (!cardId || !accountId) {
          alert("Missing cardId or accountId in URL");
          return;
        }

        try {
          // Step 1: Request ephemeral key from backend
          const response = await fetch(EPHEMERAL_FN_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cardId, accountId }),
          });

          const data = await response.json();
          if (!data.success) throw new Error(data.error);
          const ephemeralKeySecret = data.ephemeralKeySecret;

          // Step 2: Initialize Stripe
          const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

          // Step 3: Show card details using Stripeâ€™s official UI
          const result = await stripe.renderIssuingCardDetail({
            ephemeralKeySecret: ephemeralKeySecret,
            style: { base: { fontSize: "18px", color: "#000" } },
            mount: "#card-details",
          });

          if (result.error) {
            console.error(result.error);
            alert("Error showing card details: " + result.error.message);
          }
        } catch (err) {
          console.error(err);
          alert("Error showing card details: " + err.message);
        }
      }

      document.getElementById("showCardBtn").addEventListener("click", showCardDetails);
    </script>
  </body>
</html>
