<!DOCTYPE html>
<html>
  <head>
    <title>Show Issuing Card Details - URL Fetch</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      /* Basic styling to show loading/error messages clearly */
      #output {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ccc;
        min-height: 50px;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <h2>Card Details</h2>
    
    <button id="showCardDetails">Show Card Details</button>

    <div id="output">Click 'Show Card Details' to fetch the data from the URL.</div>

    <script>
      // Function to extract a parameter from the URL
      function getUrlParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      document.getElementById("showCardDetails").addEventListener("click", async () => {
        // --- 1. Fetch IDs from URL ---
        const cardId = getUrlParam('cardId');
        const accountId = getUrlParam('accountId');
        const output = document.getElementById("output");
        
        output.innerHTML = "Loading...";

        if (!cardId || !accountId) {
          output.innerHTML = `<pre>Error: Missing required parameters in URL.</pre>
          <p>Example URL format: <code>.../page.html?cardId=ic_XXXXXX&accountId=acct_XXXXXX</code></p>`;
          return;
        }

        try {
          // 2. Initialize Stripe with your platform's publishable key for nonce creation
          // NOTE: Replace 'YOUR_PLATFORM_PUBLISHABLE_KEY' with your actual key
          const stripe = Stripe('pk_test_51RnIO1PnjxZLQWbCzh7H4jjbQC8e6InO0PWjJXMsUYUVBOQUd50KqxrQfhPGEwVSwDoIS5xUBP8JvDGJ1wIr8iGr009Im9BXGV', {
             stripeAccount: accountId,
             apiVersion: "2023-10-16",
          });

          // 3. Generate Nonce on the client side
          const { nonce, error: nonceError } = await stripe.createEphemeralKeyNonce({
            issuingCard: cardId
          });

          if (nonceError) throw nonceError;
          if (!nonce) throw new Error("Nonce generation failed.");
          
          // 4. Create Ephemeral Key from backend, passing the client-generated nonce
          // NOTE: Update the Cloud Function URL
          const ephKeyResponse = await fetch("https://us-central1-teenbeez.cloudfunctions.net/createIssuingEphemeralKey", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              cardId,
              nonce: nonce, 
              accountId,
            }),
          });
          
          const ephKeyData = await ephKeyResponse.json();
          if (!ephKeyData.success) throw new Error(ephKeyData.error || "Failed to create ephemeral key");

          // 5. Re-initialize Stripe for Element creation (using the same key)
          const stripe_final = Stripe(ephKeyData.publishableKey, {
            stripeAccount: accountId,
            apiVersion: "2023-10-16", 
          });
          
          output.innerHTML = ""; // Clear loading message

          // 6. Create and mount the Issuing Card Details Element
          const detailsElement = stripe_final.createIssuingCardDetailsElement(
            ephKeyData.ephemeralKeySecret, 
            nonce 
          );

          detailsElement.mount("#output");

        } catch (err) {
          output.innerHTML = `<pre>Error showing card details: ${err.message}</pre>`;
          console.error(err);
        }
      });
    </script>
  </body>
</html>
